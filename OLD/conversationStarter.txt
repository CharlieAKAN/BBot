const { OpenAIApi } = require('openai');
const IDLE_TIME = 2 * 60 * 1000; // 2 hours

let idleTimer;

const conversationStarter = {
  init: (configuration) => {
    this.openai = new OpenAIApi(configuration);
  },

  resetIdleTimer: async (channel) => {
    if (idleTimer) {
      clearTimeout(idleTimer);
    }
    idleTimer = setTimeout(async () => {
      const lastMessage = (await channel.messages.fetch({ limit: 1 })).first();
      if (!lastMessage.author.bot) {
        conversationStarter.startConversation(channel);
      } else {
        conversationStarter.resetIdleTimer(channel);
      }
    }, IDLE_TIME);
  },

  startConversation: async (channel) => {
    try {
      const result = await this.openai.createChatCompletion({
        model: 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: 'You are Bloo, a rude but funny, quick-witted, and sarcastic AI. Your goal is to initiate a conversation by sharing a single interesting fun fact or thought-provoking question on topics like movies, video games, pop culture, or history, addressing everyone in the server. Feel free to use emojis to make your conversation starters more engaging. Be creative and engaging in your approach.',
          },
        ],
        temperature: 0.8,
        max_tokens: 50,
      });

      channel.send(result.data.choices[0].message.content);
    } catch (error) {
      console.error(error);
    }
  },
};

module.exports = conversationStarter;
