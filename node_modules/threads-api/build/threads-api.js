"use strict";!function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(exports,{DEFAULT_DEVICE:function(){return c},ThreadsAPI:function(){return d}});var e=require("axios"),t=require("mime-types"),n=require("uuid"),r=require("./constants"),s=require("./dynamic-data");function a(e,t,n,r,s,a,o){try{var i=e[a](o),u=i.value}catch(e){n(e);return}i.done?t(u):Promise.resolve(u).then(r,s)}function o(e){return function(){var t=this,n=arguments;return new Promise(function(r,s){var o=e.apply(t,n);function i(e){a(o,r,s,i,u,"next",e)}function u(e){a(o,r,s,i,u,"throw",e)}i(void 0)})}}function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function u(e,t){var n,r,s,a,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(n)throw TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&a[0]?r.return:a[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,a[1])).done)return s;switch(r=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){o.label=a[1];break}if(6===a[0]&&o.label<s[1]){o.label=s[1],s=a;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(a);break}s[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}var c={manufacturer:"OnePlus",model:"ONEPLUS+A3010",os_version:25,os_release:"7.1.1"},d=function(a){"use strict";var d=this;this.verbose=!1,this.token=void 0,this.fbLSDToken=r.DEFAULT_LSD_TOKEN,this.noUpdateToken=!1,this.noUpdateLSD=!1,this.deviceID=r.DEFAULT_DEVICE_ID,this.device=c,this.userID=void 0,this._getAppHeaders=function(){return i({"User-Agent":"Barcelona "+s.LATEST_ANDROID_APP_VERSION+" Android","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},d.token?{Authorization:"Bearer IGT:2:"+d.token}:void 0)},this._getDefaultHeaders=function(e){return i({},d._getAppHeaders(),{authority:"www.threads.net",accept:"*/*","accept-language":"ko","cache-control":"no-cache",origin:"https://www.threads.net",pragma:"no-cache","Sec-Fetch-Site":"same-origin","x-asbd-id":"129477","x-fb-lsd":d.fbLSDToken,"x-ig-app-id":"238260118697367"},e?{referer:"https://www.threads.net/@"+e}:void 0)};var l=this;this.getUserIDfromUsername=o(function(t,n){var r,s,a,o,c;return u(this,function(u){switch(u.label){case 0:return[4,e.default.get("https://www.instagram.com/"+t,i({},n,{httpAgent:l.httpAgent,httpsAgent:l.httpsAgent,headers:i({},l._getDefaultHeaders(t),{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"ko,en;q=0.9,ko-KR;q=0.8,ja;q=0.7",Authorization:void 0,referer:"https://www.instagram.com/","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"cross-site","sec-fetch-user":"?1","upgrade-insecure-requests":"1","x-asbd-id":void 0,"x-fb-lsd":void 0,"x-ig-app-id":void 0})}))];case 1:return o=null==(r=(a=(a=(a=u.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/"user_id":"(\d+)",/))?void 0:r[1],c=null==(s=a.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:s[1],!l.noUpdateLSD&&c&&(l.fbLSDToken=c,l.verbose&&console.debug("[fbLSDToken] UPDATED",l.fbLSDToken)),[2,o]}})});var h=this;this.getCurrentUserID=o(function(e){return u(this,function(t){switch(t.label){case 0:if(h.userID)return h.verbose&&console.debug("[userID] USING",h.userID),[2,h.userID];if(!h.username)throw Error("username is not defined");return[4,h.getUserIDfromUsername(h.username,e)];case 1:return h.userID=t.sent(),h.verbose&&console.debug("[userID] UPDATED",h.userID),[2,h.userID]}})});var p=this;this.getUserProfile=o(function(t,n,r){return u(this,function(s){switch(s.label){case 0:return p.verbose&&console.debug("[fbLSDToken] USING",p.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:p.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"23996318473300828"}),i({},r,{httpAgent:p.httpAgent,httpsAgent:p.httpsAgent,headers:i({},p._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRootQuery"})}))];case 1:return[2,s.sent().data.data.userData.user]}})});var f=this;this.getUserProfileThreads=o(function(t,n,r){var s,a;return u(this,function(o){switch(o.label){case 0:return f.verbose&&console.debug("[fbLSDToken] USING",f.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:f.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6232751443445612"}),i({},r,{httpAgent:f.httpAgent,httpsAgent:f.httpsAgent,headers:i({},f._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileThreadsTabQuery"})}))];case 1:return[2,(null==(a=o.sent().data.data)?void 0:null==(s=a.mediaData)?void 0:s.threads)||[]]}})});var g=this;this.getUserProfileReplies=o(function(t,n,r){var s,a;return u(this,function(o){switch(o.label){case 0:return g.verbose&&console.debug("[fbLSDToken] USING",g.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:g.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6684830921547925"}),i({},r,{httpAgent:g.httpAgent,httpsAgent:g.httpsAgent,headers:i({},g._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRepliesTabQuery"})}))];case 1:return[2,(null==(a=o.sent().data.data)?void 0:null==(s=a.mediaData)?void 0:s.threads)||[]]}})});var v=this;this.getPostIDfromThreadID=o(function(e,t){var n;return u(this,function(r){return n="https://www.threads.net/t/"+(e=(e=(e=e.split("?")[0]).replace(/\s/g,"")).replace(/\//g,"")),[2,v.getPostIDfromURL(n,t)]})});var b=this;this.getPostIDfromURL=o(function(t,n){var r,s,a,o,c;return u(this,function(u){switch(u.label){case 0:return[4,e.default.get(t,i({},n,{httpAgent:b.httpAgent,httpsAgent:b.httpsAgent}))];case 1:return o=null==(r=(a=(a=(a=u.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/{"post_id":"(.*?)"}/))?void 0:r[1],c=null==(s=a.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:s[1],!b.noUpdateLSD&&c&&(b.fbLSDToken=c,b.verbose&&console.debug("[fbLSDToken] UPDATED",b.fbLSDToken)),[2,o]}})});var _=this;this.getThreads=o(function(t,n){return u(this,function(r){switch(r.label){case 0:return _.verbose&&console.debug("[fbLSDToken] USING",_.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:_.fbLSDToken,variables:'{"postID":"'+t+'"}',doc_id:"5587632691339264"}),i({},n,{httpAgent:_.httpAgent,httpsAgent:_.httpsAgent,headers:i({},_._getDefaultHeaders(),{"x-fb-friendly-name":"BarcelonaPostPageQuery"})}))];case 1:return[2,r.sent().data.data.data]}})});var m=this;this.getThreadLikers=o(function(t,n){return u(this,function(r){switch(r.label){case 0:return m.verbose&&console.debug("[fbLSDToken] USING",m.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:m.fbLSDToken,variables:'{"mediaID":"'+t+'"}',doc_id:"9360915773983802"}),i({},n,{httpAgent:m.httpAgent,httpsAgent:m.httpsAgent,headers:m._getDefaultHeaders()}))];case 1:return[2,r.sent().data.data.likers]}})});var D=this;this._toggleAuthPostRequest=o(function(t,n){return u(this,function(r){switch(r.label){case 0:return[4,D.getToken()];case 1:if(!r.sent())throw Error("Token not found");return[4,e.default.post(t,void 0,i({},n,{httpAgent:D.httpAgent,httpsAgent:D.httpsAgent,headers:D._getDefaultHeaders()}))];case 2:return[2,r.sent()]}})});var A=this;this.like=o(function(e,t){var n;return u(this,function(s){switch(s.label){case 0:return[4,A.getCurrentUserID()];case 1:return n=s.sent(),[4,A._toggleAuthPostRequest(r.BASE_API_URL+"/media/"+e+"_"+n+"/like/",t)];case 2:return[2,"ok"===s.sent().data.status]}})});var w=this;this.unlike=o(function(e,t){var n;return u(this,function(s){switch(s.label){case 0:return[4,w.getCurrentUserID()];case 1:return n=s.sent(),[4,w._toggleAuthPostRequest(r.BASE_API_URL+"/media/"+e+"_"+n+"/unlike/",t)];case 2:return[2,"ok"===s.sent().data.status]}})});var S=this;this.follow=o(function(e,t){var n;return u(this,function(s){switch(s.label){case 0:return[4,S._toggleAuthPostRequest(r.BASE_API_URL+"/friendships/create/"+e+"/",t)];case 1:return n=s.sent(),S.verbose&&console.debug("[FOLLOW]",n.data),[2,n.data]}})});var I=this;this.unfollow=o(function(e,t){var n;return u(this,function(s){switch(s.label){case 0:return[4,I._toggleAuthPostRequest(r.BASE_API_URL+"/friendships/destroy/"+e+"/",t)];case 1:return n=s.sent(),I.verbose&&console.debug("[UNFOLLOW]",n.data),[2,n.data]}})});var k=this;this.getToken=o(function(){var t,n,s,a,o;return u(this,function(i){switch(i.label){case 0:if(k.token)return k.verbose&&console.debug("[token] USING",k.token),[2,k.token];if(!k.username||!k.password)throw Error("Username and password are required");return t=encodeURIComponent(JSON.stringify({client_input_params:{password:k.password,contact_point:k.username,device_id:""+k.deviceID},server_params:{credential_type:"password",device_id:""+k.deviceID}})),s=encodeURIComponent(JSON.stringify({bloks_version:n="5f56efad68e1edec7801f630b5c122704ec5378adbee6609a448f105f34a9c73",styles_id:"instagram"})),a={method:"POST",headers:k._getAppHeaders(),responseType:"text",data:"params="+t+"&bk_client_context="+s+"&bloks_versioning_id="+n},[4,(0,e.default)(r.LOGIN_URL,a)];case 1:return o=i.sent().data.split("Bearer IGT:2:")[1].split('"')[0].replaceAll("\\",""),k.noUpdateToken||(k.verbose&&console.debug("[token] UPDATED",o),k.token=o),[2,o]}})});var T=this;this.publish=o(function(t){var n,s,a,o,i,c,d,l;return u(this,function(u){switch(u.label){case 0:if(n="string"==typeof t?{text:t}:t,!T.username||!T.password)throw Error("Username or password not set");return[4,T.getCurrentUserID()];case 1:if(!(s=u.sent()))throw Error("User ID not found");return[4,T.getToken()];case 2:if(!u.sent())throw Error("Token not found");if(o={text_post_app_info:{reply_control:0},timezone_offset:(-(60*(a=new Date).getTimezoneOffset())).toString(),source_type:"4",_uid:s,device_id:T.deviceID,caption:n.text||"",upload_id:a.getTime(),device:T.device},i=r.POST_URL,!("image"in n&&n.image))return[3,4];return i=r.POST_WITH_IMAGE_URL,[4,T.uploadImage(n.image)];case 3:return c=u.sent().upload_id,o.upload_id=c,o.scene_capture_type="",[3,5];case 4:"url"in n&&n.url&&(o.text_post_app_info.link_attachment_url=n.url),u.label=5;case 5:return n.parentPostID&&(o.text_post_app_info.reply_id=n.parentPostID),n.image||(o.publish_mode="text_post"),d="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify(o)),[4,e.default.post(i,d,{httpAgent:T.httpAgent,httpsAgent:T.httpsAgent,headers:T._getAppHeaders(),timeout:6e4})];case 6:if(l=u.sent(),T.verbose&&console.debug("[PUBLISH]",l.data),"ok"===l.data.status)return[2,l.data.media.id];return[2,void 0]}})});var L=this;this.delete=o(function(t,n){var s,a;return u(this,function(o){switch(o.label){case 0:return s=r.BASE_API_URL+"/media/"+t+"/delete/",a="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify({media_id:t,_uid:L.userID,_uuid:L.deviceID})),[4,e.default.post(s,a,i({httpAgent:L.httpAgent,httpsAgent:L.httpsAgent,headers:L._getAppHeaders(),timeout:6e4},n))];case 1:if("ok"===o.sent().data.status)return[2,!0];return[2,!1]}})});var U=this;this.publishWithImage=o(function(e,t){return u(this,function(n){return[2,U.publish({text:e,image:t})]})});var y=this;this.uploadImage=o(function(r){var s,a,o,c,d,l,h,p,f,g,v;return u(this,function(u){switch(u.label){case 0:if(o="https://www.instagram.com/rupload_igphoto/"+(a=(s=Date.now().toString())+"_0_"+Math.floor(9e9*Math.random()+1e9)),r.startsWith("http"))return[3,3];return[4,Promise.resolve().then(function(){return require("fs")})];case 1:return[4,u.sent().promises.readFile(r)];case 2:return c=u.sent(),d=t.default.lookup(r)||"application/octet-stream",[3,5];case 3:return[4,e.default.get(r,{responseType:"arraybuffer"})];case 4:l=u.sent(),c=Buffer.from(l.data,"binary"),d=l.headers["content-type"],u.label=5;case 5:h={upload_id:s,media_type:"1",sticker_burnin_params:JSON.stringify([]),image_compression:JSON.stringify({lib_name:"moz",lib_version:"3.1.m",quality:"80"}),xsharing_user_ids:JSON.stringify([]),retry_context:JSON.stringify({num_step_auto_retry:"0",num_reupload:"0",num_step_manual_retry:"0"}),"IG-FB-Xpost-entry-point-v2":"feed"},p=c.length,f=i({},y._getDefaultHeaders(),{"Content-Type":"application/octet-stream",X_FB_PHOTO_WATERFALL_ID:(0,n.v4)(),"X-Entity-Type":void 0!==d?"image/"+d:"image/jpeg",Offset:"0","X-Instagram-Rupload-Params":JSON.stringify(h),"X-Entity-Name":a,"X-Entity-Length":p.toString(),"Content-Length":p.toString(),"Accept-Encoding":"gzip"}),y.verbose&&console.log("[UPLOAD_IMAGE] Uploading "+p.toLocaleString()+"b as "+s+"..."),u.label=6;case 6:return u.trys.push([6,8,,9]),[4,e.default.post(o,c,{httpAgent:y.httpAgent,headers:f,timeout:6e4})];case 7:return g=u.sent().data,y.verbose&&console.log("[UPLOAD_IMAGE] SUCCESS",g),[2,g];case 8:throw v=u.sent(),y.verbose&&console.log("[UPLOAD_IMAGE] FAILED",v.response.data),v;case 9:return[2]}})}),(null==a?void 0:a.token)&&(this.token=a.token),(null==a?void 0:a.fbLSDToken)&&(this.fbLSDToken=a.fbLSDToken),this.noUpdateToken=!!(null==a?void 0:a.noUpdateToken),this.noUpdateLSD=!!(null==a?void 0:a.noUpdateLSD),this.verbose=(null==a?void 0:a.verbose)||!1,this.httpAgent=null==a?void 0:a.httpAgent,this.httpsAgent=null==a?void 0:a.httpsAgent,this.username=null==a?void 0:a.username,this.password=null==a?void 0:a.password,(null==a?void 0:a.deviceID)&&(this.deviceID=a.deviceID),this.device=null==a?void 0:a.device,this.userID=null==a?void 0:a.userID};